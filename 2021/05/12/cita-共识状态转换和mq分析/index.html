<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CITA共识状态转换和MQ分析 | Tim&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="logo.png">
    <meta name="description" content="
`rust
//! 1. Subscribe channel
//!
//!     | Queue     | PubModule | Message Type          |
//!     | --------- | --------- | --------------------- |
//!     | consensus | Net       | Comp ...">
    
    <link rel="preload" href="/blog/assets/css/0.styles.15dc303e.css" as="style"><link rel="preload" href="/blog/assets/js/app.291cba69.js" as="script"><link rel="preload" href="/blog/assets/js/6.9e2f87d1.js" as="script"><link rel="preload" href="/blog/assets/js/3.ee97f597.js" as="script"><link rel="preload" href="/blog/assets/js/21.c8450320.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.85eec256.js"><link rel="prefetch" href="/blog/assets/js/11.e8cd5ec4.js"><link rel="prefetch" href="/blog/assets/js/12.e3eec23a.js"><link rel="prefetch" href="/blog/assets/js/13.f2e02d5d.js"><link rel="prefetch" href="/blog/assets/js/14.2e1379af.js"><link rel="prefetch" href="/blog/assets/js/15.6962b1c6.js"><link rel="prefetch" href="/blog/assets/js/16.adae4633.js"><link rel="prefetch" href="/blog/assets/js/17.2981595f.js"><link rel="prefetch" href="/blog/assets/js/18.5c3d2e48.js"><link rel="prefetch" href="/blog/assets/js/19.578d7149.js"><link rel="prefetch" href="/blog/assets/js/20.92b7bb8c.js"><link rel="prefetch" href="/blog/assets/js/22.f7b99824.js"><link rel="prefetch" href="/blog/assets/js/23.9922bce4.js"><link rel="prefetch" href="/blog/assets/js/24.bc0d4a10.js"><link rel="prefetch" href="/blog/assets/js/25.54dfa10b.js"><link rel="prefetch" href="/blog/assets/js/26.da4cbff9.js"><link rel="prefetch" href="/blog/assets/js/27.a599e60f.js"><link rel="prefetch" href="/blog/assets/js/28.2a72646b.js"><link rel="prefetch" href="/blog/assets/js/29.9b60bea9.js"><link rel="prefetch" href="/blog/assets/js/30.f64e88d1.js"><link rel="prefetch" href="/blog/assets/js/31.2ea5d619.js"><link rel="prefetch" href="/blog/assets/js/32.c2e851fb.js"><link rel="prefetch" href="/blog/assets/js/33.36b472dd.js"><link rel="prefetch" href="/blog/assets/js/34.3b2d2f0d.js"><link rel="prefetch" href="/blog/assets/js/35.41d78a0e.js"><link rel="prefetch" href="/blog/assets/js/4.62d20898.js"><link rel="prefetch" href="/blog/assets/js/5.28d35512.js"><link rel="prefetch" href="/blog/assets/js/7.63a47d97.js"><link rel="prefetch" href="/blog/assets/js/8.7c3ffbd2.js"><link rel="prefetch" href="/blog/assets/js/9.a0d3f175.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.3626b124.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.15dc303e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/blog/" class="nav-link home-link">Tim's Blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/blog/" class="nav-link mobile-home-link">Tim's Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        CITA共识状态转换和MQ分析
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Tim</span> <span itemprop="address">   in Guilin</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-5-12">
      2021-05-12
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/blog/tag/CITA" data-v-42ccfcd5><span data-v-42ccfcd5>CITA</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h3 id="bft模块订阅和发送的消息"><a href="#bft模块订阅和发送的消息" class="header-anchor">#</a> Bft模块订阅和发送的消息</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">//! 1. Subscribe channel</span>
<span class="token comment">//!</span>
<span class="token comment">//!     | Queue     | PubModule | Message Type          |</span>
<span class="token comment">//!     | --------- | --------- | --------------------- |</span>
<span class="token comment">//!     | consensus | Net       | CompactSignedProposal# |</span>
<span class="token comment">//!     | consensus | Net       | RawBytes#              |</span>
<span class="token comment">//!     | consensus | Chain     | RichStatus#            |</span>
<span class="token comment">//!     | consensus | Auth      | BlockTxs#              |</span>
<span class="token comment">//!     | consensus | Auth      | VerifyBlockResp#       |</span>
<span class="token comment">//!     | consensus | Snapshot  | SnapshotReq           |</span>
<span class="token comment">//!</span>
<span class="token comment">//! 2. Publish channel</span>
<span class="token comment">//!</span>
<span class="token comment">//!     | Queue     | PubModule | SubModule       | Message Type          |</span>
<span class="token comment">//!     | --------- | --------- | --------------- | --------------------- |</span>
<span class="token comment">//!     | consensus | Consensus | Auth            | VerifyBlockReq#        |</span>
<span class="token comment">//!     | consensus | Consensus | Net             | RawBytes#              |</span>
<span class="token comment">//!     | consensus | Consensus | Chain, Executor | BlockWithProof#        |</span>
<span class="token comment">//!     | consensus | Consensus | Net             | CompactSignedProposal# |</span>
<span class="token comment">//!     | consensus | Consensus | Executor        | SignedProposal        |</span>
<span class="token comment">//!     | consensus | Consensus | Snapshot        | SnapshotResp          |</span>
<span class="token comment">//!</span>
</code></pre></div><h3 id="共识的架构"><a href="#共识的架构" class="header-anchor">#</a> 共识的架构</h3> <p>共识主要有MQ(消息队列)通讯模块、交易池、定时模块、WAL(write ahead log)、算法逻辑模块。</p> <div class="language- extra-class"><pre class="language-text"><code>   +-------------+       +-------------+       +-----+
   | MQ通讯模块   |&lt;-----&gt;|  算法逻辑模块  |&lt;----&gt;| WAL |
   +-------------+       +-------------+       +-----+
          ^                ^    ^
          |                |    |
          |----------------+    |
          |                     |
     +--------+           +-----------+
     | 交易池  |           | 定时模块  |
     +--------+           +-----------+
</code></pre></div><p><strong>MQ通讯模块</strong>： CITA的消息通过MQ进行周转，MQ通讯模块负责订阅、发布基于MQ的消息。</p> <p><strong>交易池</strong>： 交易池订阅和存储交易信息，并提供交易的打包、生成Block。还进行交易的持久化，实现快速确认的功能。</p> <p><strong>定时模块</strong>： 提供算法定时服务。使用者向定时模块发送定时请求，定时模块在时间到达后，发送确认信息。</p> <p><strong>WAL</strong>： WAL提供预写日志(write ahead log)的服务，持久化各个节点的投票。用来进行节点崩溃后恢复。</p> <p><strong>算法逻辑模块</strong>： 分布式算法逻辑的实现模块，接受共识其它模块发送过来的信息，根据自身的算法要求，进行算法逻辑相应的处理。</p> <h3 id="基本约定"><a href="#基本约定" class="header-anchor">#</a> 基本约定</h3> <ol><li><p>规定 H 为当前高度，R 为当前轮次，N 为该轮参与共识的节点数量，B 为当前区块，在每一个高度下，达成共识至少需要一轮；</p></li> <li><p>一个包含 +2/3 的对应于处在 &lt;H, R&gt; 的特定区块或者 nil（空区块）的预投票的集合，称之为锁变化证明(Proof-of-lock-change)，简称 PoLC。</p></li></ol> <h3 id="状态转换图"><a href="#状态转换图" class="header-anchor">#</a> 状态转换图</h3> <p><img src="C:%5CUsers%5C94764%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201129102029596.png" alt="image-20201129102029596"></p> <h3 id="一、状态转换描述"><a href="#一、状态转换描述" class="header-anchor">#</a> 一、状态转换描述</h3> <p><strong>Bft 的代码实现，就是一个大的状态机，以及一个定时器，状态由链上消息通信以及计时器 timeout_process() 推动</strong>。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Step</span> <span class="token punctuation">{</span>
    <span class="token class-name">Propose</span><span class="token punctuation">,</span> <span class="token operator">/</span>
    <span class="token class-name">ProposeWait</span><span class="token punctuation">,</span>
    <span class="token class-name">Prevote</span><span class="token punctuation">,</span>
    <span class="token class-name">PrevoteWait</span><span class="token punctuation">,</span>
    <span class="token class-name">PrecommitAuth</span><span class="token punctuation">,</span>
    <span class="token class-name">Precommit</span><span class="token punctuation">,</span>
    <span class="token class-name">PrecommitWait</span><span class="token punctuation">,</span>
    <span class="token class-name">Commit</span><span class="token punctuation">,</span>
    <span class="token class-name">CommitWait</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">WaitTimer</span> <span class="token punctuation">{</span>
    timer_seter<span class="token punctuation">:</span> <span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">TimeoutInfo</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    timer_notify<span class="token punctuation">:</span> <span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">TimeoutInfo</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Propose</strong>：每个节点检查自己是否是 proposer。proposer 广播当前轮次的 proposal</p> <p><strong>ProposeWait</strong>：非提议节点对 proposal 进行基本检查并向 Auth 发送验证请求</p> <p><strong>Prevote</strong>：节点进行预投票</p> <p><strong>PrevoteWait</strong>：等待其他节点的预投票</p> <p><strong>PrecommitAuth</strong>：等待 Auth 返回对区块 B 的校验结果</p> <p><strong>Precommit</strong>：节点进行预提交</p> <p><strong>PrecommitWait</strong>：等待其他节点对特定 proposal 的预提交</p> <p><strong>Commit</strong>：提交区块 B 给 Chain 微服务和 Executor 微服务</p> <p><strong>CommitWait</strong>：等待 Chain 发来的最新状态（rich_status）消息</p> <h4 id="_1-1-propose-h-r-→-proposewait-h-r"><a href="#_1-1-propose-h-r-→-proposewait-h-r" class="header-anchor">#</a> 1.1 PROPOSE &lt;H, R&gt; → PROPOSEWAIT &lt;H, R&gt;</h4> <p>新一轮开始时**（Auth  &gt;&gt; BlockTxs）**，共识节点处于 Propose&lt;H, R&gt; 状态，共识节点通过计算 (H+R) % N 确定本轮的 proposer&lt;H, R&gt;，接着重置并启动一个计时器 T0 （T0 = 3s） ：</p> <ul><li>如果该共识节点就是本轮的 proposer&lt;H, R&gt;，就广播这一轮的提议 proposal&lt;H, R, B&gt;（Consensus &gt;&gt; Net）</li> <li>如果该共识节点不是本轮的 proposer&lt;H, R&gt;，就重置并启动一个计时器 T1（T1 = T0 * 24 / 30 * (R + 1) ）</li></ul> <p>共识节点进入 ProposeWait&lt;H, R&gt; 状态。</p> <h4 id="_1-2-proposewait-h-r-→-prevote-h-r"><a href="#_1-2-proposewait-h-r-→-prevote-h-r" class="header-anchor">#</a> 1.2 PROPOSEWAIT &lt;H, R&gt; → PREVOTE &lt;H, R&gt;</h4> <ul><li>如果共识节点是 proposer&lt;H, R&gt; ，共识节点对自己发出的 proposal&lt;H, R, B&gt; 投 prevote&lt;H, R, B&gt;</li> <li>如果共识节点不是 proposer&lt;H, R&gt; 且在 T1 内收到 proposal&lt;H, R, B&gt;，共识节点对该 proposal&lt;H, R, B&gt; 做基本检查</li> <li><ul><li>如果 proposal&lt;H, R, B&gt; 通过了基本检查， 则向 Auth 发送请求验证 B 的合法性**(Consensus &gt;&gt; VerifyBlockReq)**，共识节点对该 proposal&lt;H, R, B&gt; 投 prevote&lt;H, R, B&gt;</li> <li>如果 proposal&lt;H, R, B&gt; 没有通过基本检查，共识节点对 nil&lt;H, R&gt; 投 prevote&lt;H, R, B&gt;</li></ul></li> <li>如果共识节点不是 proposer&lt;H, R&gt; 且在 T1 内没有收到 proposer&lt;H, R&gt; 发出的 proposal&lt;H, R, B&gt;，共识节点对 nil&lt;H, R&gt; 投 prevote&lt;H, R, P&gt;</li></ul> <p>共识节点将 prevote&lt;H, R, B&gt; 投票保存到本地，并进入 Prevote&lt;H, R&gt; 状态。共识节点重置并启动一个计时器 T2 以重新广播 prevote&lt;H, R, P&gt; 投票。</p> <h4 id="_1-3-prevote-h-r-→-prevotewait-h-r"><a href="#_1-3-prevote-h-r-→-prevotewait-h-r" class="header-anchor">#</a> 1.3 PREVOTE&lt;H, R&gt; → PREVOTEWAIT&lt;H, R&gt;</h4> <p>共识节点收到 +2/3 的 prevote&lt;H, R, P&gt; 后, 进入 PrevoteWait&lt;H, R&gt; 状态，同时重置并启动一个计时器 T3（T3 = T0 * 1 / 30 = 0.1s）。</p> <h4 id="_1-4-prevotewait-h-r-→-precommit-h-r-或者-prevotewait-h-r-→-precommitauth-h-r"><a href="#_1-4-prevotewait-h-r-→-precommit-h-r-或者-prevotewait-h-r-→-precommitauth-h-r" class="header-anchor">#</a> 1.4 PREVOTEWAIT&lt;H, R&gt; → PRECOMMIT&lt;H, R&gt; 或者 PREVOTEWAIT&lt;H, R&gt; → PRECOMMITAUTH&lt;H, R&gt;</h4> <ul><li>如果共识节点在 T3 内收到 +2/3 的共识节点对 proposal&lt;H, R, B&gt; 的 prevote&lt;H, R, B&gt;</li> <li><ul><li>如果 Auth 对 B 的验证 **(Auth &gt;&gt; VerifyBlockResp)**通过，共识节点对该 proposal&lt;H, R, B&gt; 投 precommit&lt;H, R, B&gt;，共识节点进入 Precommit&lt;H, R&gt; 状态</li> <li>如果 Auth 对 B 的验证 **(Auth &gt;&gt; VerifyBlockResp)**不通过，共识节点对 nil&lt;H,R&gt; 投 precommit&lt;H, R, B&gt;，共识节点进入 Precommit&lt;H, R&gt; 状态</li> <li>如果 Auth 还没有返回对 B 的验证结果，共识节点重置并启动一个 T4（T4 = T0 * 1 / 30 * 15 = 1.5s）计时器，并进入 PrecommitAuth 状态</li></ul></li> <li>如果共识节点在 T3 内收到 +2/3 的共识节点对 nil&lt;H, R&gt; 的 prevote&lt;H, R, P&gt;，共识节点对 nil&lt;H,R&gt; 投 precommit&lt;H, R, P&gt;，共识节点进入 Precommit&lt;H, R&gt; 状态</li> <li>如果共识节点在 T3 内没有满足以上条件，共识节点对 nil&lt;H, R&gt; 投 precommit&lt;H, R, B&gt;，共识节点进入 Precommit&lt;H, R&gt; 状态</li></ul> <p>如果共识节点投了 precommit&lt;H, R, B&gt;，便重置并启动一个 T5（T5 = T0 * 1 / 30 * 15 = 1.5s）计时器以重发 prevote&lt;H, R, P&gt; 和 precommit&lt;H, R, P&gt;。</p> <h4 id="_1-5-precommitauth-h-r-→-precommit-h-r"><a href="#_1-5-precommitauth-h-r-→-precommit-h-r" class="header-anchor">#</a> 1.5 PRECOMMITAUTH&lt;H, R&gt; → PRECOMMIT&lt;H, R&gt;</h4> <p>如果共识节点在 T4 时间内没有收到 Auth 返回，就再次向 Auth 请求验证**(Consensus &gt;&gt; VerifyBlockReq)**区块，并一直等待，直到收到 Auth 返回：</p> <ul><li>如果 Auth 对区块的验证**(Auth &gt;&gt; VerifyBlockResp)**通过，共识节点对 proposal&lt;H, R, B&gt; 投 precommit&lt;H, R, P&gt;，共识节点进入 Precommit&lt;H, R&gt; 状态</li> <li>如果 Auth 对区块的验证**(Auth &gt;&gt; VerifyBlockResp)**不通过，共识节点对 nil&lt;H, R&gt; 投 prevote&lt;H, R, B&gt; 和 precommit&lt;H, R, B&gt;，共识节点进入Precommit&lt;H, R&gt; 状态</li></ul> <p>PRECOMMIT&lt;H, R&gt; → PRECOMMITWAIT&lt;H, R&gt;</p> <p>当共识节点收到 +2/3 的 precommit&lt;H, R, B&gt; 后，进入 PrecommitWait&lt;H, R&gt; 状态，同时重置并启动一个计时器 T6（T6 = T0 * 1 / 30 = 0.1s）。</p> <h4 id="_1-6-precommitwait-h-r-→-commit-h-r-或者-precommitwait-h-r-→-prepare-h-r-1"><a href="#_1-6-precommitwait-h-r-→-commit-h-r-或者-precommitwait-h-r-→-prepare-h-r-1" class="header-anchor">#</a> 1.6 PRECOMMITWAIT&lt;H, R&gt; → COMMIT&lt;H, R&gt; 或者 PRECOMMITWAIT&lt;H, R&gt; → PREPARE&lt;H, R + 1&gt;</h4> <ul><li>如果共识节点在 T6 内收到 +2/3 的共识节点对特定 proposal&lt;H, R, B&gt; 的 precommit&lt;H, R, B&gt; ，共识节点将区块 B 发送给 Executor 微服务和 Chain 微服务处理**（Consensus &gt;&gt; BlockWithProof）**</li> <li>如果共识节点在 T6 内收到 +2/3 的共识节点对 nil&lt;H, R&gt; 的 precommit&lt;H, R, B&gt; ，共识节点进入 Propose&lt;H, R+1&gt; 状态</li> <li>如果共识节点在 T6 内没有满足以上条件，共识节点进入 Propose&lt;H, R+1&gt; 状态</li></ul> <h4 id="_1-7-commit-h-r-→-commitwait-h-r"><a href="#_1-7-commit-h-r-→-commitwait-h-r" class="header-anchor">#</a> 1.7 COMMIT&lt;H, R&gt; → COMMITWAIT&lt;H, R&gt;</h4> <p>共识节点收到 Chain 发来的最新共识区块返回的消息 rich_status 后**（Chain  &gt;&gt; RichStatus）**，进入 CommitWait&lt;H, R&gt; 状态。</p> <h4 id="_1-8-commitwait-h-r-→-propose-h-1-0"><a href="#_1-8-commitwait-h-r-→-propose-h-1-0" class="header-anchor">#</a> 1.8 COMMITWAIT&lt;H, R&gt; → PROPOSE&lt;H + 1, 0&gt;</h4> <p>共识节点等待 T0 超时，进入 Propose&lt;H + 1, 0&gt; 状态。</p> <h2 id="二、subscribe-channel"><a href="#二、subscribe-channel" class="header-anchor">#</a> 二、Subscribe channel</h2> <h3 id="_2-1-compactsignedproposal"><a href="#_2-1-compactsignedproposal" class="header-anchor">#</a> 2.1 CompactSignedProposal</h3> <p>共识节点通过Net收到Proposer节点的CompactSignedProposal</p> <p>接到已经签名的 proposal ，判断自身是否有权利投票、判断高度、验证签名、验证该轮是否为此节点提出 proposal 、发送该 proposal 下的 block transaction 给 auth 验证交易是否正常等一系列验证操作，最后给 计时器发送一个计时消息，转至 <code>Step::ProposeWait</code> 状态。</p> <div class="language-rust extra-class"><pre class="language-rust"><code> <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Net</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">CompactSignedProposal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">handle_proposal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>body<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这个函数是对proposal的详细处理</span>
                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> res <span class="token punctuation">{</span>
                        <span class="token macro property">trace!</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;process {} recieve handle_proposal ok; h: {}, r: {}&quot;</span><span class="token punctuation">,</span>
                            <span class="token keyword">self</span><span class="token punctuation">,</span>
                            h<span class="token punctuation">,</span>
                            r<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&amp;&amp;</span> r <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>round <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>step <span class="token operator">&lt;</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">Prevote</span> <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span>step <span class="token operator">=</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">ProposeWait</span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>timer_seter<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">TimeoutInfo</span> <span class="token punctuation">{</span>
                                timeval<span class="token punctuation">:</span> nowG <span class="token operator">+</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                height<span class="token punctuation">:</span> h<span class="token punctuation">,</span>
                                round<span class="token punctuation">:</span> r<span class="token punctuation">,</span>
                                step<span class="token punctuation">:</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">ProposeWait</span><span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token macro property">trace!</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;process {} fail handle_proposal {}&quot;</span><span class="token punctuation">,</span>
                            <span class="token keyword">self</span><span class="token punctuation">,</span>
                            res<span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
</code></pre></div><p>CompactSignedProposal 消息结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactSignedProposal</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> proposal<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">CompactProposal</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> signature<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 签名</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactProposal</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> block<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>blockchain<span class="token punctuation">::</span></span><span class="token class-name">CompactBlock</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> islock<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> lock_round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> lock_votes<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token class-name">Vote</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> 
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactBlock</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> version<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> header<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">BlockHeader</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> body<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">CompactBlockBody</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactBlockBody</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> tx_hashes<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 交易内容</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>CompactSignedProposal 样例</p> <div class="language-json extra-class"><pre class="language-json"><code>recieve CompactSignedProposal content<span class="token operator">:</span> 
proposal <span class="token punctuation">{</span>
  block <span class="token punctuation">{</span>
    version<span class="token operator">:</span> <span class="token number">2</span>
    header <span class="token punctuation">{</span>
      prevhash<span class="token operator">:</span> <span class="token string">&quot;\356\001c\341\366\212\250\&quot;R1\356|\332\007T\235y\027PK\307)\252\377\2630&gt;\276\331\232 \007&quot;</span>
      timestamp<span class="token operator">:</span> <span class="token number">1609302994419</span>
      height<span class="token operator">:</span> <span class="token number">18</span>
      transactions_root<span class="token operator">:</span> <span class="token string">&quot;\310\340\317\240\351i\210\023~]\303\347&lt;\225#\001\356\036^\336\037\200\346P\261\362Y\227b\307\236\033&quot;</span>
      proof <span class="token punctuation">{</span>
        content<span class="token operator">:</span> <span class="token string">&quot;B\000\000\000\000\000\000\0000x525eb27908f10e12417a612fe7b17f7f48699857107f03db96416d0db0cfe8b7\021\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000\000\000\000\000\000*\000\000\000\000\000\000\0000x019691e3b8aab4d2e0c64827b7539fc0bc232116A\000\000\000\000\000\000\000\314\251\254\311{l\030\301x5\027}\323\367\253\177\017\221\0171\236\352\253&amp;U\032=\022\254\027\366\300FL\323\204\t~\036\343\001Y\035&gt;\247\233\243\320\202\303X\215\377\351\327)\027\375\223\304Z\254\212\032\001*\000\000\000\000\000\000\0000x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4A\000\000\000\000\000\000\000/\227\2711\\\021&amp;*\016\232p\2651\036\027\305\351Di\241\243\\\3222\314\344\307\365R\314h-;\227\201x{\027\317\327\206Y\240\315F\3656\201\014\242\335;\251\2039\201\211\354}\304TZ\207\354\000*\000\000\000\000\000\000\0000x4da4204662e7fd97d39d21b476bef5cbbf8d2232A\000\000\000\000\000\000\000\251\276-G\270\002\273K4S&amp;\353z\355\354\000l\362\321M\371\350\3674X0\342\205\3741\000n.\ngSt\303\330\215\222[\022\003u\374\016\253\325\341\242\345:\303+\336\307\006\313\313=1t\004\001&quot;</span>
        type<span class="token operator">:</span> Bft
      <span class="token punctuation">}</span>
      proposer<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
    <span class="token punctuation">}</span>
    body <span class="token punctuation">{</span>
      tx_hashes<span class="token operator">:</span> <span class="token string">&quot;\254\332\244\252\036q\337}\223\324\223yC\374\023\243\301\240\360i\241\242\216\270\223AC:\320l]y&quot;</span>
      tx_hashes<span class="token operator">:</span> <span class="token string">&quot;\212 \235A\216\334\261\200\361\333\346&gt;\227\314&lt;\020Wt\013&amp;\n\312\371\362w::\221\220O\260\324&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  height<span class="token operator">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span>
signature<span class="token operator">:</span> <span class="token string">&quot;n\247\020\200\346\255\250\225\211&amp;S\2059\247k\202u\335\222\310d\037\354\350a\310\237\265k\305xU\t\004\211&gt;\243NQ\214B9\237\276\350}\320&gt;nwi\307Y\374\317\346,8\023\243\263\373\216\034\000&quot;</span>
 by proposer
</code></pre></div><h3 id="_2-2-rawbytes"><a href="#_2-2-rawbytes" class="header-anchor">#</a> 2.2 RawBytes</h3> <p>RawBytes，接到对 proposal 的投票消息，根据投票的轮数不同分别处理，如果数据正常，则分别进入 <code>Step::PrevoteWait</code> 和 <code>Step::PrecommitWait</code> 状态。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Net</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">RawBytes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> raw_bytes <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">take_raw_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">handle_message</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>raw_bytes<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> res <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">Prevote</span> <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">proc_prevote</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">proc_precommit</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
</code></pre></div><p>RawBytes 样例</p> <div class="language-json extra-class"><pre class="language-json"><code>receive RawBytes 
height<span class="token operator">:</span><span class="token number">18</span> 
round<span class="token operator">:</span><span class="token number">0</span> 
step<span class="token operator">:</span>Precommit 
author.address<span class="token operator">:</span>0x019691e3b8aab4d2e0c64827b7539fc0bc232116 hash<span class="token operator">:</span>Some(0xf6ab3e3be72c74bcc07e2d679ddd223a030a966123b1db323155a263a35be932) 
signature<span class="token operator">:</span>Signature <span class="token punctuation">{</span> r<span class="token operator">:</span> <span class="token string">&quot;08eae1f7561b241a78f0b3ee624fd2d67ab144c613f70e8f7c214e1d1a8b6fe9&quot;</span><span class="token punctuation">,</span> 
                     s<span class="token operator">:</span> <span class="token string">&quot;07e57283d763229656468b31417723638ec9aa066a71f4fc0b4e69b2398435f2&quot;</span><span class="token punctuation">,</span> 
                     v<span class="token operator">:</span> <span class="token string">&quot;00&quot;</span> <span class="token punctuation">}</span>

其中Signature <span class="token punctuation">{</span>
    <span class="token comment">/// Get a slice into the 'r' portion of the data.</span>
    pub fn r(&amp;self) -&gt; &amp;<span class="token punctuation">[</span>u8<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        &amp;self.<span class="token number">0</span><span class="token punctuation">[</span><span class="token number">0</span>..<span class="token number">32</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Get a slice into the 's' portion of the data.</span>
    pub fn s(&amp;self) -&gt; &amp;<span class="token punctuation">[</span>u8<span class="token punctuation">]</span> <span class="token punctuation">{</span>
        &amp;self.<span class="token number">0</span><span class="token punctuation">[</span><span class="token number">32</span>..<span class="token number">64</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Get the recovery byte.</span>
    pub fn v(&amp;self) -&gt; u8 <span class="token punctuation">{</span>
        self.<span class="token number">0</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-3-richstatus"><a href="#_2-3-richstatus" class="header-anchor">#</a> 2.3 RichStatus</h3> <p>RichStatus，消息来自于 chain ，根据传输过来的状态表达的含义有多种，如果高度等于上一次共识高度，则表明块commit成功，bft 状态由 <code>Step::Commit</code> 更改为 <code>Step::CommitWait</code>; 如果高度等于上一次共识高度 - 1，则说明commit出现了异常，bft 重新将上一次的共识结果发送到 MQ（如果还保留着的话）。同时根据 Richstatus 中的共识列表、prev_hash 等重要信息更新自身的信息。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Chain</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">RichStatus</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> rich_status <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">take_rich_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">trace!</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;process {} get new local status {:?}&quot;</span><span class="token punctuation">,</span>
                        <span class="token keyword">self</span><span class="token punctuation">,</span>
                        rich_status<span class="token punctuation">.</span>height
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">receive_new_status</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rich_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> authorities<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Address</span><span class="token operator">&gt;</span> <span class="token operator">=</span> rich_status
                        <span class="token punctuation">.</span><span class="token function">get_nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Address</span><span class="token punctuation">::</span><span class="token function">from_slice</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">trace!</span><span class="token punctuation">(</span><span class="token string">&quot;authorities: [{:?}]&quot;</span><span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">let</span> validators<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Address</span><span class="token operator">&gt;</span> <span class="token operator">=</span> rich_status
                        <span class="token punctuation">.</span><span class="token function">get_validators</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Address</span><span class="token punctuation">::</span><span class="token function">from_slice</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">trace!</span><span class="token punctuation">(</span><span class="token string">&quot;validators: [{:?}]&quot;</span><span class="token punctuation">,</span> validators<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> validators<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>params<span class="token punctuation">.</span>signer<span class="token punctuation">.</span>address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>consensus_power <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token macro property">info!</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;address[{:?}] is not consensus power !&quot;</span><span class="token punctuation">,</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span>params<span class="token punctuation">.</span>signer<span class="token punctuation">.</span>address
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>consensus_power <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>auth_manage<span class="token punctuation">.</span><span class="token function">receive_authorities_list</span><span class="token punctuation">(</span>
                        rich_status<span class="token punctuation">.</span>height <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>authorities<span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>validators<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> version <span class="token operator">=</span> rich_status<span class="token punctuation">.</span><span class="token function">get_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">trace!</span><span class="token punctuation">(</span><span class="token string">&quot;verison: {}&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre></div><p>RichStatus消息结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">RichStatus</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> hash<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> nodes<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> interval<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> version<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> validators<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>RichStatus样例</p> <div class="language-json extra-class"><pre class="language-json"><code>receive RichStatus content<span class="token operator">:</span> hash<span class="token operator">:</span> <span class="token string">&quot;\223\213%\212\325\002\254qM\344h80\231\247\246\3274\002\257\240\200*e\371\310\326\3432\177\006\303&quot;</span>
height<span class="token operator">:</span> <span class="token number">18</span>
nodes<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
nodes<span class="token operator">:</span> <span class="token string">&quot;M\244 Fb\347\375\227\323\235!\264v\276\365\313\277\215\&quot;2&quot;</span>
nodes<span class="token operator">:</span> <span class="token string">&quot;\001\226\221\343\270\252\264\322\340\306H'\267S\237\300\274#!\026&quot;</span>
interval<span class="token operator">:</span> <span class="token number">3000</span>
version<span class="token operator">:</span> <span class="token number">2</span>
validators<span class="token operator">:</span> <span class="token string">&quot;\001\226\221\343\270\252\264\322\340\306H'\267S\237\300\274#!\026&quot;</span>
validators<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
validators<span class="token operator">:</span> <span class="token string">&quot;M\244 Fb\347\375\227\323\235!\264v\276\365\313\277\215\&quot;2&quot;</span>
</code></pre></div><h3 id="_2-4-blocktxs"><a href="#_2-4-blocktxs" class="header-anchor">#</a> 2.4 BlockTxs</h3> <p>BlockTxs 消息来自于 Auth，chain 落盘成功后的 Richstatus 消息 Auth 接到后，清除交易池中对应的交易，并从交易池中按一定顺序打包一份新的交易，发送给 bft。bft 接到消息后，先序列化到本地，再判断这个高度和轮数是否是自己出块，如果是，验证必要信息后生成一个新的 proposal，广播给整个链，发送计时消息。</p> <div class="language-rust extra-class"><pre class="language-rust"><code> <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Auth</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">BlockTxs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> block_txs <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">take_block_txs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token macro property">debug!</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;process {} recieve BlockTxs h: {}&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 接受到BlockTxs</span>
                        <span class="token keyword">self</span><span class="token punctuation">,</span>
                        block_txs<span class="token punctuation">.</span><span class="token function">get_height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> height <span class="token operator">=</span> block_txs<span class="token punctuation">.</span><span class="token function">get_height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>block_txs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>block_txs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> block_txs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>wal_log<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> <span class="token class-name">LogType</span><span class="token punctuation">::</span><span class="token class-name">AuthTxs</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> now_height <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height<span class="token punctuation">;</span>
                    <span class="token keyword">let</span> now_round <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>round<span class="token punctuation">;</span>
                    <span class="token keyword">let</span> now_step <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>step<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> now_height <span class="token operator">==</span> height <span class="token operator">+</span> <span class="token number">1</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span>
     						<span class="token comment">// 检查是不是proposer</span>
                            <span class="token punctuation">.</span><span class="token function">is_round_proposer</span><span class="token punctuation">(</span>now_height<span class="token punctuation">,</span> now_round<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>params<span class="token punctuation">.</span>signer<span class="token punctuation">.</span>address<span class="token punctuation">)</span>  
                            <span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> now_step <span class="token operator">==</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">ProposeWait</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>proposal<span class="token punctuation">.</span><span class="token function">is_none</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">new_proposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开启新提议 自己签名、验证后，发送CompactSignedProposal到Net</span>
                        <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>timer_seter<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">TimeoutInfo</span> <span class="token punctuation">{</span>
                            timeval<span class="token punctuation">:</span> now <span class="token operator">+</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            height<span class="token punctuation">:</span> now_height<span class="token punctuation">,</span>
                            round<span class="token punctuation">:</span> now_round<span class="token punctuation">,</span>
                            step<span class="token punctuation">:</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">ProposeWait</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
</code></pre></div><p>BlockTxs消息结构：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">BlockTxs</span> <span class="token punctuation">{</span> <span class="token comment">// 块</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> body<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">BlockBody</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">BlockBody</span> <span class="token punctuation">{</span> <span class="token comment">// 块体</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> transactions<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token class-name">SignedTransaction</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 交易列表</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SignedTransaction</span> <span class="token punctuation">{</span> <span class="token comment">// 验证通过的交易</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> transaction_with_sig<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">UnverifiedTransaction</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> tx_hash<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// SignedTransaction hash</span>
    <span class="token keyword">pub</span> signer<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">UnverifiedTransaction</span> <span class="token punctuation">{</span> <span class="token comment">// 带签名的交易</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> transaction<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">Transaction</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> signature<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> crypto<span class="token punctuation">:</span> <span class="token class-name">Crypto</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Transaction</span> <span class="token punctuation">{</span> <span class="token comment">// 原始交易内容</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> to<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>string<span class="token punctuation">::</span></span><span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> nonce<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>string<span class="token punctuation">::</span></span><span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> quota<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> valid_until_block<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> data<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> value<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> chain_id<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> version<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> to_v1<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> chain_id_v1<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>BlockTxs样例</p> <div class="language-json extra-class"><pre class="language-json"><code>recieve BlockTxs h<span class="token operator">:</span> <span class="token number">17</span> content<span class="token operator">:</span> height<span class="token operator">:</span> <span class="token number">17</span>
body <span class="token punctuation">{</span>
  transactions <span class="token punctuation">{</span>
    transaction_with_sig <span class="token punctuation">{</span>
      transaction <span class="token punctuation">{</span>
        nonce<span class="token operator">:</span> <span class="token string">&quot;ea42756e121f49e28ca34f10b02394ce&quot;</span>
        quota<span class="token operator">:</span> <span class="token number">10000000</span>
        valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
        data<span class="token operator">:</span> <span class="token string">&quot;\003&quot;</span>
        value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
        version<span class="token operator">:</span> <span class="token number">2</span>
        to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
        chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
      <span class="token punctuation">}</span>
      signature<span class="token operator">:</span> <span class="token string">&quot;\243\360\303\216TPt\304&amp;\316d\223\324\217ugl\375\313\275\177\343\021N&gt;\357yYY\204\261\000\006\3628\&quot;\276\223v\316n\327\206\244d\224\320\205Q\204\3338\023p\265\3175\210T\214f\200\210\350\001&quot;</span>
    <span class="token punctuation">}</span>
    tx_hash<span class="token operator">:</span> <span class="token string">&quot;\254\332\244\252\036q\337}\223\324\223yC\374\023\243\301\240\360i\241\242\216\270\223AC:\320l]y&quot;</span>
    signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
  <span class="token punctuation">}</span>
  transactions <span class="token punctuation">{</span>
    transaction_with_sig <span class="token punctuation">{</span>
      transaction <span class="token punctuation">{</span>
        nonce<span class="token operator">:</span> <span class="token string">&quot;f28f497522f440c7921a1e27b581dc83&quot;</span>
        quota<span class="token operator">:</span> <span class="token number">10000000</span>
        valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
        data<span class="token operator">:</span> <span class="token string">&quot;\004&quot;</span>
        value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
        version<span class="token operator">:</span> <span class="token number">2</span>
        to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
        chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
      <span class="token punctuation">}</span>
      signature<span class="token operator">:</span> <span class="token string">&quot;\260l\202\004v\336RL)\311\372&lt;\003\016\364^i\203\224,\305\237\246\206\344t5\370`y\330\014\007I\231\262\262\374\006\376\277J\324\274\214\034\243NXOv\301S\225v_h\244pI\362\023`\267\000&quot;</span>
    <span class="token punctuation">}</span>
    tx_hash<span class="token operator">:</span> <span class="token string">&quot;\212 \235A\216\334\261\200\361\333\346&gt;\227\314&lt;\020Wt\013&amp;\n\312\371\362w::\221\220O\260\324&quot;</span>
    signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-5-verifyblockresp"><a href="#_2-5-verifyblockresp" class="header-anchor">#</a> 2.5 VerifyBlockResp</h3> <p>VerifyBlockResp，消息来自于 Auth，Auth 接到 bft 发的交易信息并验证后，返回结果，如果验证无误，移除待验证交易列表中对应的交易，并将该 proposal 序列化到磁盘，状态切换为 <code>Step::Precommit</code>， 检查投票信息，如果投票信息已经大于 2/3 了，那么随即转入 <code>Step::PrecommitWait</code> 状态；如果验证失败，清除待验证交易信息，并广播，投空票，转入 <code>Step::Precommit</code>状态，检查投票信息，如果投票信息已经大于 2/3 了，那么随即转入 <code>Step::PrecommitWait</code> 状态</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Auth</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">VerifyBlockResp</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> resp <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">take_verify_block_resp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">let</span> block <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">get_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> vheight <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">get_height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> vround <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">get_round</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">;</span>

                    <span class="token keyword">let</span> verify_res <span class="token operator">=</span> <span class="token keyword">if</span> resp<span class="token punctuation">.</span><span class="token function">get_pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Save the verified block which has passed verification by the auth.</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>verified_blocks
                            <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">crypt_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">VerifiedBlockStatus</span><span class="token punctuation">::</span><span class="token class-name">Ok</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">VerifiedBlockStatus</span><span class="token punctuation">::</span><span class="token class-name">Err</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>unverified_msg<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>vheight<span class="token punctuation">,</span> vround<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        res<span class="token number">.1</span> <span class="token operator">=</span> verify_res<span class="token punctuation">;</span>
                        <span class="token keyword">let</span> block_bytes<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span> <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>
                            <span class="token operator">&amp;</span><span class="token punctuation">(</span>vheight<span class="token punctuation">,</span> vround<span class="token punctuation">,</span> verify_res<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block_bytes<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">Infinite</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>wal_log<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>vheight<span class="token punctuation">,</span> <span class="token class-name">LogType</span><span class="token punctuation">::</span><span class="token class-name">VerifiedBlock</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// Send SignedProposal to executor.</span>
                        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>compact_signed_proposal<span class="token punctuation">)</span> <span class="token operator">=</span>
                            res<span class="token number">.0</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take_compact_signed_proposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{</span>
                            <span class="token keyword">let</span> signed_proposal <span class="token operator">=</span> compact_signed_proposal
                                <span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">get_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> signed_proposal<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender
                                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
                                    <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">SignedProposal</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    msg<span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>

                    <span class="token macro property">info!</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;process {} recieve Auth VerifyBlockResp h: {}, r: {}, resp: {:?}&quot;</span><span class="token punctuation">,</span>
                        <span class="token keyword">self</span><span class="token punctuation">,</span> vheight<span class="token punctuation">,</span> vround<span class="token punctuation">,</span> verify_res<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> vheight <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&amp;&amp;</span> vround <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>round <span class="token punctuation">{</span>
                        <span class="token comment">//verify not ok,so clean the proposal info</span>
                        <span class="token keyword">if</span> verify_res<span class="token punctuation">.</span><span class="token function">is_ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>step <span class="token operator">==</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">PrecommitAuth</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">pre_proc_precommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">change_state_step</span><span class="token punctuation">(</span>vheight<span class="token punctuation">,</span> vround<span class="token punctuation">,</span> <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">Precommit</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">proc_precommit</span><span class="token punctuation">(</span>vheight<span class="token punctuation">,</span> vround<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">clean_proposal_when_verify_failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
</code></pre></div><p>VerifyBlockResp消息结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">VerifyBlockResp</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> pass<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> block<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>blockchain<span class="token punctuation">::</span></span><span class="token class-name">Block</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>VerifyBlockResp消息样例</p> <div class="language-json extra-class"><pre class="language-json"><code>receive VerifyBlockResp content<span class="token operator">:</span> height<span class="token operator">:</span> <span class="token number">18</span>
pass<span class="token operator">:</span> <span class="token boolean">true</span>
block <span class="token punctuation">{</span>
  version<span class="token operator">:</span> <span class="token number">2</span>
  header <span class="token punctuation">{</span>
    prevhash<span class="token operator">:</span> <span class="token string">&quot;\356\001c\341\366\212\250\&quot;R1\356|\332\007T\235y\027PK\307)\252\377\2630&gt;\276\331\232 \007&quot;</span>
    timestamp<span class="token operator">:</span> <span class="token number">1609302994419</span>
    height<span class="token operator">:</span> <span class="token number">18</span>
    transactions_root<span class="token operator">:</span> <span class="token string">&quot;\310\340\317\240\351i\210\023~]\303\347&lt;\225#\001\356\036^\336\037\200\346P\261\362Y\227b\307\236\033&quot;</span>
    proof <span class="token punctuation">{</span>
      content<span class="token operator">:</span> <span class="token string">&quot;B\000\000\000\000\000\000\0000x525eb27908f10e12417a612fe7b17f7f48699857107f03db96416d0db0cfe8b7\021\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000\000\000\000\000\000*\000\000\000\000\000\000\0000x019691e3b8aab4d2e0c64827b7539fc0bc232116A\000\000\000\000\000\000\000\314\251\254\311{l\030\301x5\027}\323\367\253\177\017\221\0171\236\352\253&amp;U\032=\022\254\027\366\300FL\323\204\t~\036\343\001Y\035&gt;\247\233\243\320\202\303X\215\377\351\327)\027\375\223\304Z\254\212\032\001*\000\000\000\000\000\000\0000x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4A\000\000\000\000\000\000\000/\227\2711\\\021&amp;*\016\232p\2651\036\027\305\351Di\241\243\\\3222\314\344\307\365R\314h-;\227\201x{\027\317\327\206Y\240\315F\3656\201\014\242\335;\251\2039\201\211\354}\304TZ\207\354\000*\000\000\000\000\000\000\0000x4da4204662e7fd97d39d21b476bef5cbbf8d2232A\000\000\000\000\000\000\000\251\276-G\270\002\273K4S&amp;\353z\355\354\000l\362\321M\371\350\3674X0\342\205\3741\000n.\ngSt\303\330\215\222[\022\003u\374\016\253\325\341\242\345:\303+\336\307\006\313\313=1t\004\001&quot;</span>
      type<span class="token operator">:</span> Bft
    <span class="token punctuation">}</span>
    proposer<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
  <span class="token punctuation">}</span>
  body <span class="token punctuation">{</span>
    transactions <span class="token punctuation">{</span>
      transaction_with_sig <span class="token punctuation">{</span>
        transaction <span class="token punctuation">{</span>
          nonce<span class="token operator">:</span> <span class="token string">&quot;ea42756e121f49e28ca34f10b02394ce&quot;</span>
          quota<span class="token operator">:</span> <span class="token number">10000000</span>
          valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
          data<span class="token operator">:</span> <span class="token string">&quot;\003&quot;</span>
          value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
          version<span class="token operator">:</span> <span class="token number">2</span>
          to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
          chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
        <span class="token punctuation">}</span>
        signature<span class="token operator">:</span> <span class="token string">&quot;\243\360\303\216TPt\304&amp;\316d\223\324\217ugl\375\313\275\177\343\021N&gt;\357yYY\204\261\000\006\3628\&quot;\276\223v\316n\327\206\244d\224\320\205Q\204\3338\023p\265\3175\210T\214f\200\210\350\001&quot;</span>
      <span class="token punctuation">}</span>
      tx_hash<span class="token operator">:</span> <span class="token string">&quot;\254\332\244\252\036q\337}\223\324\223yC\374\023\243\301\240\360i\241\242\216\270\223AC:\320l]y&quot;</span>
      signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
    <span class="token punctuation">}</span>
    transactions <span class="token punctuation">{</span>
      transaction_with_sig <span class="token punctuation">{</span>
        transaction <span class="token punctuation">{</span>
          nonce<span class="token operator">:</span> <span class="token string">&quot;f28f497522f440c7921a1e27b581dc83&quot;</span>
          quota<span class="token operator">:</span> <span class="token number">10000000</span>
          valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
          data<span class="token operator">:</span> <span class="token string">&quot;\004&quot;</span>
          value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
          version<span class="token operator">:</span> <span class="token number">2</span>
          to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
          chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
        <span class="token punctuation">}</span>
        signature<span class="token operator">:</span> <span class="token string">&quot;\260l\202\004v\336RL)\311\372&lt;\003\016\364^i\203\224,\305\237\246\206\344t5\370`y\330\014\007I\231\262\262\374\006\376\277J\324\274\214\034\243NXOv\301S\225v_h\244pI\362\023`\267\000&quot;</span>
      <span class="token punctuation">}</span>
      tx_hash<span class="token operator">:</span> <span class="token string">&quot;\212 \235A\216\334\261\200\361\333\346&gt;\227\314&lt;\020Wt\013&amp;\n\312\371\362w::\221\220O\260\324&quot;</span>
      signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-6-snapshotreq"><a href="#_2-6-snapshotreq" class="header-anchor">#</a> 2.6 SnapshotReq</h3> <p>CITA 提供了快照工具，给当前区块链某一个节点做快照，保存某个高度的状态、区块等数据，然后将快照恢复到另一个节点/本节点，就可以在较短时间内同步/恢复区块链数据。</p> <p>收到快照请求，做快照处理</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Snapshot</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">SnapshotReq</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">process_snapshot</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">process_snapshot</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">mut</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">take_snapshot_req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不同cmd对应快照的不同操作</span>
            <span class="token keyword">match</span> req<span class="token punctuation">.</span>cmd <span class="token punctuation">{</span>
                <span class="token class-name">Cmd</span><span class="token punctuation">::</span><span class="token class-name">Snapshot</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;receive Snapshot::Snapshot: {:?}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">snapshot_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender<span class="token punctuation">,</span> <span class="token class-name">Resp</span><span class="token punctuation">::</span><span class="token class-name">SnapshotAck</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Cmd</span><span class="token punctuation">::</span><span class="token class-name">Begin</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
                    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;receive Snapshot::Begin: {:?}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_snapshot</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>is_cleared <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token function">snapshot_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender<span class="token punctuation">,</span> <span class="token class-name">Resp</span><span class="token punctuation">::</span><span class="token class-name">BeginAck</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Cmd</span><span class="token punctuation">::</span><span class="token class-name">Restore</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;receive Snapshot::Restore: {:?}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">snapshot_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender<span class="token punctuation">,</span> <span class="token class-name">Resp</span><span class="token punctuation">::</span><span class="token class-name">RestoreAck</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Cmd</span><span class="token punctuation">::</span><span class="token class-name">Clear</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;receive Snapshot::Clear: {:?}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> walpath <span class="token operator">=</span> <span class="token class-name">DataPath</span><span class="token punctuation">::</span><span class="token function">wal_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> tmp_path <span class="token operator">=</span> <span class="token class-name">DataPath</span><span class="token punctuation">::</span><span class="token function">root_node_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/wal_tmp&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>wal_log <span class="token operator">=</span> <span class="token class-name">Wal</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>tmp_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">remove_dir_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>walpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>wal_log <span class="token operator">=</span> <span class="token class-name">Wal</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>walpath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">let</span> _ <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">remove_dir_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">self</span><span class="token punctuation">.</span>is_cleared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                    <span class="token function">snapshot_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender<span class="token punctuation">,</span> <span class="token class-name">Resp</span><span class="token punctuation">::</span><span class="token class-name">ClearAck</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Cmd</span><span class="token punctuation">::</span><span class="token class-name">End</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;receive Snapshot::End: {:?}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>is_cleared <span class="token punctuation">{</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>consensus_power <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">clean_verified_info</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">clean_saved_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">clean_filter_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>block_txs<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>proposals<span class="token punctuation">.</span>proposals<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>votes<span class="token punctuation">.</span>votes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>proof <span class="token operator">=</span> <span class="token class-name">BftProof</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">get_proof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>pre_hash <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span>block_proof <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">change_state_step</span><span class="token punctuation">(</span>
                            req<span class="token punctuation">.</span>end_height <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
                            <span class="token number">0</span><span class="token punctuation">,</span>
                            <span class="token class-name">Step</span><span class="token punctuation">::</span><span class="token class-name">PrecommitAuth</span><span class="token punctuation">,</span>
                            <span class="token boolean">true</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">save_wal_proof</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>end_height <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_snapshot</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>is_cleared <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                    <span class="token function">snapshot_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender<span class="token punctuation">,</span> <span class="token class-name">Resp</span><span class="token punctuation">::</span><span class="token class-name">EndAck</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回SnapshotResp</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">snapshot_response</span><span class="token punctuation">(</span>sender<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> ack<span class="token punctuation">:</span> <span class="token class-name">Resp</span><span class="token punctuation">,</span> flag<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;snapshot_response ack: {:?}, flag: {}&quot;</span><span class="token punctuation">,</span> ack<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> resp <span class="token operator">=</span> <span class="token class-name">SnapshotResp</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resp<span class="token punctuation">.</span><span class="token function">set_resp</span><span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resp<span class="token punctuation">.</span><span class="token function">set_flag</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sender
        <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
            <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">SnapshotResp</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="三、publish-channel"><a href="#三、publish-channel" class="header-anchor">#</a> 三、Publish channel</h2> <h3 id="_3-1-verifyblockreq"><a href="#_3-1-verifyblockreq" class="header-anchor">#</a> 3.1 VerifyBlockReq</h3> <p>共识节点向Auth模块请求验证 B 的合法性</p> <div class="language-rust extra-class"><pre class="language-rust"><code> <span class="token keyword">fn</span> <span class="token function-definition function">handle_proposal</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        wal_flag<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
        need_verify<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">usize</span><span class="token punctuation">,</span> <span class="token keyword">usize</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">EngineError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">...</span><span class="token punctuation">...</span>
        <span class="token punctuation">...</span><span class="token punctuation">...</span>
        <span class="token punctuation">...</span><span class="token punctuation">...</span>
        <span class="token comment">// 请求Auth验证合法性</span>
		<span class="token keyword">if</span> need_verify <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">verify_req</span><span class="token punctuation">(</span>csp_msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>compact_block<span class="token punctuation">,</span> height<span class="token punctuation">,</span> round<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">&quot;handle_proposal {} verify_req is error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">EngineError</span><span class="token punctuation">::</span><span class="token class-name">InvalidTxInProposal</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">...</span><span class="token punctuation">...</span>
        <span class="token punctuation">...</span><span class="token punctuation">...</span>
        <span class="token punctuation">...</span><span class="token punctuation">..</span>
<span class="token punctuation">}</span>


<span class="token keyword">fn</span> <span class="token function-definition function">verify_req</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        csp_msg<span class="token punctuation">:</span> <span class="token class-name">Message</span><span class="token punctuation">,</span>
        compact_block<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">CompactBlock</span><span class="token punctuation">,</span>
        vheight<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        vround<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> tx_hashes <span class="token operator">=</span> compact_block<span class="token punctuation">.</span><span class="token function">get_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_tx_hashes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If there is no transaction, the block don't have to be verified.</span>
        <span class="token keyword">if</span> tx_hashes<span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>verified_blocks<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
                compact_block<span class="token punctuation">.</span><span class="token function">crypt_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                compact_block<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> verify_ok <span class="token operator">=</span> compact_block<span class="token punctuation">.</span><span class="token function">check_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> verify_ok <span class="token punctuation">{</span>
            <span class="token keyword">let</span> verify_req <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> verify_req <span class="token operator">=</span> <span class="token namespace">auth<span class="token punctuation">::</span></span><span class="token class-name">VerifyBlockReq</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                verify_req<span class="token punctuation">.</span><span class="token function">set_height</span><span class="token punctuation">(</span>vheight <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                verify_req<span class="token punctuation">.</span><span class="token function">set_round</span><span class="token punctuation">(</span>vround <span class="token keyword">as</span> <span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                verify_req<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>compact_block<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                verify_req
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> verify_req<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">set_origin</span><span class="token punctuation">(</span>csp_msg<span class="token punctuation">.</span><span class="token function">get_origin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
                    <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">VerifyBlockReq</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    msg<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>unverified_msg
                <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vheight<span class="token punctuation">,</span> vround<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>csp_msg<span class="token punctuation">,</span> <span class="token class-name">VerifiedBlockStatus</span><span class="token punctuation">::</span><span class="token class-name">Init</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        verify_ok
    <span class="token punctuation">}</span>
</code></pre></div><p>VerifyBlockReq消息结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">VerifyBlockReq</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> block<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>blockchain<span class="token punctuation">::</span></span><span class="token class-name">CompactBlock</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>VerifyBlockReq消息样例</p> <div class="language-json extra-class"><pre class="language-json"><code>send VerifyBlockReq content<span class="token operator">:</span> 
height<span class="token operator">:</span> <span class="token number">18</span>
block <span class="token punctuation">{</span>
  version<span class="token operator">:</span> <span class="token number">2</span>
  header <span class="token punctuation">{</span>
    prevhash<span class="token operator">:</span> <span class="token string">&quot;\356\001c\341\366\212\250\&quot;R1\356|\332\007T\235y\027PK\307)\252\377\2630&gt;\276\331\232 \007&quot;</span>
    timestamp<span class="token operator">:</span> <span class="token number">1609302994419</span>
    height<span class="token operator">:</span> <span class="token number">18</span>
    transactions_root<span class="token operator">:</span> <span class="token string">&quot;\310\340\317\240\351i\210\023~]\303\347&lt;\225#\001\356\036^\336\037\200\346P\261\362Y\227b\307\236\033&quot;</span>
    proof <span class="token punctuation">{</span>
      content<span class="token operator">:</span> <span class="token string">&quot;B\000\000\000\000\000\000\0000x525eb27908f10e12417a612fe7b17f7f48699857107f03db96416d0db0cfe8b7\021\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000\000\000\000\000\000*\000\000\000\000\000\000\0000x019691e3b8aab4d2e0c64827b7539fc0bc232116A\000\000\000\000\000\000\000\314\251\254\311{l\030\301x5\027}\323\367\253\177\017\221\0171\236\352\253&amp;U\032=\022\254\027\366\300FL\323\204\t~\036\343\001Y\035&gt;\247\233\243\320\202\303X\215\377\351\327)\027\375\223\304Z\254\212\032\001*\000\000\000\000\000\000\0000x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4A\000\000\000\000\000\000\000/\227\2711\\\021&amp;*\016\232p\2651\036\027\305\351Di\241\243\\\3222\314\344\307\365R\314h-;\227\201x{\027\317\327\206Y\240\315F\3656\201\014\242\335;\251\2039\201\211\354}\304TZ\207\354\000*\000\000\000\000\000\000\0000x4da4204662e7fd97d39d21b476bef5cbbf8d2232A\000\000\000\000\000\000\000\251\276-G\270\002\273K4S&amp;\353z\355\354\000l\362\321M\371\350\3674X0\342\205\3741\000n.\ngSt\303\330\215\222[\022\003u\374\016\253\325\341\242\345:\303+\336\307\006\313\313=1t\004\001&quot;</span>
      type<span class="token operator">:</span> Bft
    <span class="token punctuation">}</span>
    proposer<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
  <span class="token punctuation">}</span>
  body <span class="token punctuation">{</span>
    tx_hashes<span class="token operator">:</span> <span class="token string">&quot;\254\332\244\252\036q\337}\223\324\223yC\374\023\243\301\240\360i\241\242\216\270\223AC:\320l]y&quot;</span>
    tx_hashes<span class="token operator">:</span> <span class="token string">&quot;\212 \235A\216\334\261\200\361\333\346&gt;\227\314&lt;\020Wt\013&amp;\n\312\371\362w::\221\220O\260\324&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-2-rawbytes"><a href="#_3-2-rawbytes" class="header-anchor">#</a> 3.2 RawBytes</h3> <p>RawBytes，在如下函数调用<code>pub_and_broadcast_message</code>，将Bft 签名好的 proposol 或者投票消息，发送到Net然后分发广播</p> <ul><li>pre_proc_prevote</li> <li>pre_proc_precommit</li> <li>retrans_vote</li> <li>clean_proposal_when_verify_failed</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">pub_and_broadcast_message</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        round<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
        step<span class="token punctuation">:</span> <span class="token class-name">Step</span><span class="token punctuation">,</span>
        hash<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token constant">H256</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> author <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>params<span class="token punctuation">.</span>signer<span class="token punctuation">;</span>
        <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> round<span class="token punctuation">,</span> step<span class="token punctuation">,</span> author<span class="token punctuation">.</span>address<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Infinite</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> signature <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">::</span><span class="token function">sign</span><span class="token punctuation">(</span>author<span class="token punctuation">.</span>keypair<span class="token punctuation">.</span><span class="token function">privkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">.</span><span class="token function">crypt_hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> sig <span class="token operator">=</span> signature<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Infinite</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">trace!</span><span class="token punctuation">(</span>
            <span class="token string">&quot;pub_and_broadcast_message {} begin h: {}, r: {}, s: {}&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            round<span class="token punctuation">,</span>
            step<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">pub_message</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">...</span><span class="token punctuation">...</span>
		<span class="token punctuation">...</span><span class="token punctuation">...</span>
		<span class="token punctuation">...</span><span class="token punctuation">...</span>
        
    <span class="token punctuation">}</span>


<span class="token keyword">fn</span> <span class="token function-definition function">pub_message</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender
            <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
                <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">RawBytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                msg<span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>RawBytes样例</p> <div class="language-json extra-class"><pre class="language-json"><code>send RawBytes 
height<span class="token operator">:</span><span class="token number">18</span> 
round<span class="token operator">:</span><span class="token number">0</span> 
step<span class="token operator">:</span>Precommit 
author.address<span class="token operator">:</span>0x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4 hash<span class="token operator">:</span>Some(0xf6ab3e3be72c74bcc07e2d679ddd223a030a966123b1db323155a263a35be932) 
signature<span class="token operator">:</span>Signature <span class="token punctuation">{</span> r<span class="token operator">:</span> <span class="token string">&quot;e7e255cc1051abbe6063b39bf6ec21a2c9acf509039196a725d8cc647de7b05d&quot;</span><span class="token punctuation">,</span> 
                     s<span class="token operator">:</span> <span class="token string">&quot;3219304b94467cf911a0052dff09e7941142d0cb9a009b1cd5838a71d2b8e9bb&quot;</span><span class="token punctuation">,</span> 
                     v<span class="token operator">:</span> <span class="token string">&quot;01&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-3-blockwithproof"><a href="#_3-3-blockwithproof" class="header-anchor">#</a> 3.3 BlockWithProof</h3> <p>将共识好的块发送给Chain和Executor，存储块到链上</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">pub_block</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> block<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">BlockWithProof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender
            <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
                <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">BlockWithProof</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                msg<span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>BlockWithProof结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">BlockWithProof</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> blk<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">Block</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> proof<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">Proof</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>BlockWithProof样例</p> <div class="language-json extra-class"><pre class="language-json"><code>send BlockWithProof content<span class="token operator">:</span> 
blk <span class="token punctuation">{</span>
  version<span class="token operator">:</span> <span class="token number">2</span>
  header <span class="token punctuation">{</span>
    prevhash<span class="token operator">:</span> <span class="token string">&quot;\356\001c\341\366\212\250\&quot;R1\356|\332\007T\235y\027PK\307)\252\377\2630&gt;\276\331\232 \007&quot;</span>
    timestamp<span class="token operator">:</span> <span class="token number">1609302994419</span>
    height<span class="token operator">:</span> <span class="token number">18</span>
    transactions_root<span class="token operator">:</span> <span class="token string">&quot;\310\340\317\240\351i\210\023~]\303\347&lt;\225#\001\356\036^\336\037\200\346P\261\362Y\227b\307\236\033&quot;</span>
    proof <span class="token punctuation">{</span>
      content<span class="token operator">:</span> <span class="token string">&quot;B\000\000\000\000\000\000\0000x525eb27908f10e12417a612fe7b17f7f48699857107f03db96416d0db0cfe8b7\021\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000\000\000\000\000\000*\000\000\000\000\000\000\0000x019691e3b8aab4d2e0c64827b7539fc0bc232116A\000\000\000\000\000\000\000\314\251\254\311{l\030\301x5\027}\323\367\253\177\017\221\0171\236\352\253&amp;U\032=\022\254\027\366\300FL\323\204\t~\036\343\001Y\035&gt;\247\233\243\320\202\303X\215\377\351\327)\027\375\223\304Z\254\212\032\001*\000\000\000\000\000\000\0000x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4A\000\000\000\000\000\000\000/\227\2711\\\021&amp;*\016\232p\2651\036\027\305\351Di\241\243\\\3222\314\344\307\365R\314h-;\227\201x{\027\317\327\206Y\240\315F\3656\201\014\242\335;\251\2039\201\211\354}\304TZ\207\354\000*\000\000\000\000\000\000\0000x4da4204662e7fd97d39d21b476bef5cbbf8d2232A\000\000\000\000\000\000\000\251\276-G\270\002\273K4S&amp;\353z\355\354\000l\362\321M\371\350\3674X0\342\205\3741\000n.\ngSt\303\330\215\222[\022\003u\374\016\253\325\341\242\345:\303+\336\307\006\313\313=1t\004\001&quot;</span>
      type<span class="token operator">:</span> Bft
    <span class="token punctuation">}</span>
    proposer<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
  <span class="token punctuation">}</span>
  body <span class="token punctuation">{</span>
    transactions <span class="token punctuation">{</span>
      transaction_with_sig <span class="token punctuation">{</span>
        transaction <span class="token punctuation">{</span>
          nonce<span class="token operator">:</span> <span class="token string">&quot;ea42756e121f49e28ca34f10b02394ce&quot;</span>
          quota<span class="token operator">:</span> <span class="token number">10000000</span>
          valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
          data<span class="token operator">:</span> <span class="token string">&quot;\003&quot;</span>
          value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
          version<span class="token operator">:</span> <span class="token number">2</span>
          to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
          chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
        <span class="token punctuation">}</span>
        signature<span class="token operator">:</span> <span class="token string">&quot;\243\360\303\216TPt\304&amp;\316d\223\324\217ugl\375\313\275\177\343\021N&gt;\357yYY\204\261\000\006\3628\&quot;\276\223v\316n\327\206\244d\224\320\205Q\204\3338\023p\265\3175\210T\214f\200\210\350\001&quot;</span>
      <span class="token punctuation">}</span>
      tx_hash<span class="token operator">:</span> <span class="token string">&quot;\254\332\244\252\036q\337}\223\324\223yC\374\023\243\301\240\360i\241\242\216\270\223AC:\320l]y&quot;</span>
      signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
    <span class="token punctuation">}</span>
    transactions <span class="token punctuation">{</span>
      transaction_with_sig <span class="token punctuation">{</span>
        transaction <span class="token punctuation">{</span>
          nonce<span class="token operator">:</span> <span class="token string">&quot;f28f497522f440c7921a1e27b581dc83&quot;</span>
          quota<span class="token operator">:</span> <span class="token number">10000000</span>
          valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
          data<span class="token operator">:</span> <span class="token string">&quot;\004&quot;</span>
          value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
          version<span class="token operator">:</span> <span class="token number">2</span>
          to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
          chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
        <span class="token punctuation">}</span>
        signature<span class="token operator">:</span> <span class="token string">&quot;\260l\202\004v\336RL)\311\372&lt;\003\016\364^i\203\224,\305\237\246\206\344t5\370`y\330\014\007I\231\262\262\374\006\376\277J\324\274\214\034\243NXOv\301S\225v_h\244pI\362\023`\267\000&quot;</span>
      <span class="token punctuation">}</span>
      tx_hash<span class="token operator">:</span> <span class="token string">&quot;\212 \235A\216\334\261\200\361\333\346&gt;\227\314&lt;\020Wt\013&amp;\n\312\371\362w::\221\220O\260\324&quot;</span>
      signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
proof <span class="token punctuation">{</span>
  content<span class="token operator">:</span> <span class="token string">&quot;B\000\000\000\000\000\000\0000xf6ab3e3be72c74bcc07e2d679ddd223a030a966123b1db323155a263a35be932\022\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000\000\000\000\000\000*\000\000\000\000\000\000\0000x4da4204662e7fd97d39d21b476bef5cbbf8d2232A\000\000\000\000\000\000\000\271x\031@\360}\245g\213]B\203\317\0204\312\t\305\206P\205'\017_z\273\315t\004\316 tB\330\236\221\357\231gR\033Eof\2219\234W\222hc&lt;\036e\270\206\321H\206\334 a\306\236\001*\000\000\000\000\000\000\0000x019691e3b8aab4d2e0c64827b7539fc0bc232116A\000\000\000\000\000\000\000\010\352\341\367V\033$\032x\360\263\356bO\322\326z\261D\306\023\367\016\217|!N\035\032\213o\351\007\345r\203\327c\&quot;\226VF\2131Aw#c\216\311\252\006jq\364\374\013Ni\2629\2045\362\000*\000\000\000\000\000\000\0000x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4A\000\000\000\000\000\000\000\347\342U\314\020Q\253\276`c\263\233\366\354!\242\311\254\365\t\003\221\226\247%\330\314d}\347\260]2\0310K\224F|\371\021\240\005-\377\t\347\224\021B\320\313\232\000\233\034\325\203\212q\322\270\351\273\001&quot;</span>
  type<span class="token operator">:</span> Bft
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-4-compactsignedproposal"><a href="#_3-4-compactsignedproposal" class="header-anchor">#</a> 3.4 CompactSignedProposal</h3> <p>将验证签名过的Proposal发送到网络</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// Send CompactSignedProposal to nextwork.</span>
        <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> compact_signed_proposal<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> bmsg<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender
            <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
                <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">CompactSignedProposal</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                msg<span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bmsg
</code></pre></div><p>CompactSignedProposal 消息结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactSignedProposal</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> proposal<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">CompactProposal</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> signature<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 签名</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactProposal</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> block<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>blockchain<span class="token punctuation">::</span></span><span class="token class-name">CompactBlock</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> islock<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> lock_round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> lock_votes<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token class-name">Vote</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> 
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactBlock</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> version<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> header<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">BlockHeader</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> body<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">CompactBlockBody</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CompactBlockBody</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> tx_hashes<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 交易内容</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>CompactSignedProposal样例</p> <div class="language-json extra-class"><pre class="language-json"><code>send CompactSignedProposal content<span class="token operator">:</span> 
proposal <span class="token punctuation">{</span>
  block <span class="token punctuation">{</span>
    version<span class="token operator">:</span> <span class="token number">2</span>
    header <span class="token punctuation">{</span>
      prevhash<span class="token operator">:</span> <span class="token string">&quot;\356\001c\341\366\212\250\&quot;R1\356|\332\007T\235y\027PK\307)\252\377\2630&gt;\276\331\232 \007&quot;</span>
      timestamp<span class="token operator">:</span> <span class="token number">1609302994419</span>
      height<span class="token operator">:</span> <span class="token number">18</span>
      transactions_root<span class="token operator">:</span> <span class="token string">&quot;\310\340\317\240\351i\210\023~]\303\347&lt;\225#\001\356\036^\336\037\200\346P\261\362Y\227b\307\236\033&quot;</span>
      proof <span class="token punctuation">{</span>
        content<span class="token operator">:</span> <span class="token string">&quot;B\000\000\000\000\000\000\0000x525eb27908f10e12417a612fe7b17f7f48699857107f03db96416d0db0cfe8b7\021\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000\000\000\000\000\000*\000\000\000\000\000\000\0000x019691e3b8aab4d2e0c64827b7539fc0bc232116A\000\000\000\000\000\000\000\314\251\254\311{l\030\301x5\027}\323\367\253\177\017\221\0171\236\352\253&amp;U\032=\022\254\027\366\300FL\323\204\t~\036\343\001Y\035&gt;\247\233\243\320\202\303X\215\377\351\327)\027\375\223\304Z\254\212\032\001*\000\000\000\000\000\000\0000x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4A\000\000\000\000\000\000\000/\227\2711\\\021&amp;*\016\232p\2651\036\027\305\351Di\241\243\\\3222\314\344\307\365R\314h-;\227\201x{\027\317\327\206Y\240\315F\3656\201\014\242\335;\251\2039\201\211\354}\304TZ\207\354\000*\000\000\000\000\000\000\0000x4da4204662e7fd97d39d21b476bef5cbbf8d2232A\000\000\000\000\000\000\000\251\276-G\270\002\273K4S&amp;\353z\355\354\000l\362\321M\371\350\3674X0\342\205\3741\000n.\ngSt\303\330\215\222[\022\003u\374\016\253\325\341\242\345:\303+\336\307\006\313\313=1t\004\001&quot;</span>
        type<span class="token operator">:</span> Bft
      <span class="token punctuation">}</span>
      proposer<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
    <span class="token punctuation">}</span>
    body <span class="token punctuation">{</span>
      tx_hashes<span class="token operator">:</span> <span class="token string">&quot;\254\332\244\252\036q\337}\223\324\223yC\374\023\243\301\240\360i\241\242\216\270\223AC:\320l]y&quot;</span>
      tx_hashes<span class="token operator">:</span> <span class="token string">&quot;\212 \235A\216\334\261\200\361\333\346&gt;\227\314&lt;\020Wt\013&amp;\n\312\371\362w::\221\220O\260\324&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  height<span class="token operator">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span>
signature<span class="token operator">:</span> <span class="token string">&quot;n\247\020\200\346\255\250\225\211&amp;S\2059\247k\202u\335\222\310d\037\354\350a\310\237\265k\305xU\t\004\211&gt;\243NQ\214B9\237\276\350}\320&gt;nwi\307Y\374\317\346,8\023\243\263\373\216\034\000&quot;</span>
 to network
</code></pre></div><h3 id="_3-5-signedproposal"><a href="#_3-5-signedproposal" class="header-anchor">#</a> 3.5 SignedProposal</h3> <p>Executor接到 Bft 发来的已经签名的 proposal，向backlogs插入记录</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// Consensus发送</span>
<span class="token comment">// If consensus has the full verified block, then send it to executor.</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>verified_blocks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Send SignedProposal to executor.</span>
            <span class="token keyword">let</span> signed_proposal <span class="token operator">=</span> compact_signed_proposal
                <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">get_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get_transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> signed_proposal<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>pub_sender
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
                    <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">SignedProposal</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    msg<span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Executor接收</span>
<span class="token comment">// SignedProposal{Proposal { height, ...}, signature}</span>
            <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">SignedProposal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> proposal <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">take_signed_proposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> open_block <span class="token operator">=</span> <span class="token class-name">OpenBlock</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>proposal<span class="token punctuation">.</span><span class="token function">take_proposal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>backlogs<span class="token punctuation">.</span><span class="token function">insert_proposal</span><span class="token punctuation">(</span>open_block<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
</code></pre></div><p>SignedProposal消息结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SignedProposal</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> proposal<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token class-name">Proposal</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> signature<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">std<span class="token punctuation">::</span>vec<span class="token punctuation">::</span></span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Proposal</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> block<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>blockchain<span class="token punctuation">::</span></span><span class="token class-name">Block</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> islock<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> lock_round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> lock_votes<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">RepeatedField</span><span class="token operator">&lt;</span><span class="token class-name">Vote</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> round<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关于BackLog：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// When a block is processed done and proofed, we can say this block is completed. So that our</span>
<span class="token comment">// chain grows up.</span>
<span class="token comment">// So, a Backlog `is_completed` return true if open block, proof, and closed block for that</span>
<span class="token comment">// height are all exist and matched.</span>
</code></pre></div><p>SignedProposal样例</p> <div class="language-json extra-class"><pre class="language-json"><code>end SignedProposal content<span class="token operator">:</span> 
proposal <span class="token punctuation">{</span>
  block <span class="token punctuation">{</span>
    version<span class="token operator">:</span> <span class="token number">2</span>
    header <span class="token punctuation">{</span>
      prevhash<span class="token operator">:</span> <span class="token string">&quot;\356\001c\341\366\212\250\&quot;R1\356|\332\007T\235y\027PK\307)\252\377\2630&gt;\276\331\232 \007&quot;</span>
      timestamp<span class="token operator">:</span> <span class="token number">1609302994419</span>
      height<span class="token operator">:</span> <span class="token number">18</span>
      transactions_root<span class="token operator">:</span> <span class="token string">&quot;\310\340\317\240\351i\210\023~]\303\347&lt;\225#\001\356\036^\336\037\200\346P\261\362Y\227b\307\236\033&quot;</span>
      proof <span class="token punctuation">{</span>
        content<span class="token operator">:</span> <span class="token string">&quot;B\000\000\000\000\000\000\0000x525eb27908f10e12417a612fe7b17f7f48699857107f03db96416d0db0cfe8b7\021\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\003\000\000\000\000\000\000\000*\000\000\000\000\000\000\0000x019691e3b8aab4d2e0c64827b7539fc0bc232116A\000\000\000\000\000\000\000\314\251\254\311{l\030\301x5\027}\323\367\253\177\017\221\0171\236\352\253&amp;U\032=\022\254\027\366\300FL\323\204\t~\036\343\001Y\035&gt;\247\233\243\320\202\303X\215\377\351\327)\027\375\223\304Z\254\212\032\001*\000\000\000\000\000\000\0000x5bd2a07d8e08f50a20acab485ebb8095d6f7c4f4A\000\000\000\000\000\000\000/\227\2711\\\021&amp;*\016\232p\2651\036\027\305\351Di\241\243\\\3222\314\344\307\365R\314h-;\227\201x{\027\317\327\206Y\240\315F\3656\201\014\242\335;\251\2039\201\211\354}\304TZ\207\354\000*\000\000\000\000\000\000\0000x4da4204662e7fd97d39d21b476bef5cbbf8d2232A\000\000\000\000\000\000\000\251\276-G\270\002\273K4S&amp;\353z\355\354\000l\362\321M\371\350\3674X0\342\205\3741\000n.\ngSt\303\330\215\222[\022\003u\374\016\253\325\341\242\345:\303+\336\307\006\313\313=1t\004\001&quot;</span>
        type<span class="token operator">:</span> Bft
      <span class="token punctuation">}</span>
      proposer<span class="token operator">:</span> <span class="token string">&quot;[\322\240}\216\010\365\n \254\253H^\273\200\225\326\367\304\364&quot;</span>
    <span class="token punctuation">}</span>
    body <span class="token punctuation">{</span>
      transactions <span class="token punctuation">{</span>
        transaction_with_sig <span class="token punctuation">{</span>
          transaction <span class="token punctuation">{</span>
            nonce<span class="token operator">:</span> <span class="token string">&quot;ea42756e121f49e28ca34f10b02394ce&quot;</span>
            quota<span class="token operator">:</span> <span class="token number">10000000</span>
            valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
            data<span class="token operator">:</span> <span class="token string">&quot;\003&quot;</span>
            value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
            version<span class="token operator">:</span> <span class="token number">2</span>
            to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
            chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
          <span class="token punctuation">}</span>
          signature<span class="token operator">:</span> <span class="token string">&quot;\243\360\303\216TPt\304&amp;\316d\223\324\217ugl\375\313\275\177\343\021N&gt;\357yYY\204\261\000\006\3628\&quot;\276\223v\316n\327\206\244d\224\320\205Q\204\3338\023p\265\3175\210T\214f\200\210\350\001&quot;</span>
        <span class="token punctuation">}</span>
        tx_hash<span class="token operator">:</span> <span class="token string">&quot;\254\332\244\252\036q\337}\223\324\223yC\374\023\243\301\240\360i\241\242\216\270\223AC:\320l]y&quot;</span>
        signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
      <span class="token punctuation">}</span>
      transactions <span class="token punctuation">{</span>
        transaction_with_sig <span class="token punctuation">{</span>
          transaction <span class="token punctuation">{</span>
            nonce<span class="token operator">:</span> <span class="token string">&quot;f28f497522f440c7921a1e27b581dc83&quot;</span>
            quota<span class="token operator">:</span> <span class="token number">10000000</span>
            valid_until_block<span class="token operator">:</span> <span class="token number">104</span>
            data<span class="token operator">:</span> <span class="token string">&quot;\004&quot;</span>
            value<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span>
            version<span class="token operator">:</span> <span class="token number">2</span>
            to_v1<span class="token operator">:</span> <span class="token string">&quot;\033\345\027\006\343Es\0168\234IU\274\3220\nXm\222\272&quot;</span>
            chain_id_v1<span class="token operator">:</span> <span class="token string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\001&quot;</span>
          <span class="token punctuation">}</span>
          signature<span class="token operator">:</span> <span class="token string">&quot;\260l\202\004v\336RL)\311\372&lt;\003\016\364^i\203\224,\305\237\246\206\344t5\370`y\330\014\007I\231\262\262\374\006\376\277J\324\274\214\034\243NXOv\301S\225v_h\244pI\362\023`\267\000&quot;</span>
        <span class="token punctuation">}</span>
        tx_hash<span class="token operator">:</span> <span class="token string">&quot;\212 \235A\216\334\261\200\361\333\346&gt;\227\314&lt;\020Wt\013&amp;\n\312\371\362w::\221\220O\260\324&quot;</span>
        signer<span class="token operator">:</span> <span class="token string">&quot;y\353\361\213\3752h\203L\026\222\203\201\223Rw\232\274\224\206\254\220\036\362f\227'wA\357\277\370g\332\303\321%\204\360\003\223U:5\212?\350\014\263&gt;\250\221\013C\351\207\244\275\021_?\036\003\236&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  height<span class="token operator">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span>
signature<span class="token operator">:</span> <span class="token string">&quot;n\247\020\200\346\255\250\225\211&amp;S\2059\247k\202u\335\222\310d\037\354\350a\310\237\265k\305xU\t\004\211&gt;\243NQ\214B9\237\276\350}\320&gt;nwi\307Y\374\317\346,8\023\243\263\373\216\034\000&quot;</span>

</code></pre></div><h3 id="_3-6-snapshotresp"><a href="#_3-6-snapshotresp" class="header-anchor">#</a> 3.6 SnapshotResp</h3> <p>CITA 提供了快照工具，给当前区块链某一个节点做快照，保存某个高度的状态、区块等数据，然后将快照恢复到另一个节点/本节点，就可以在较短时间内同步/恢复区块链数据。</p> <p>返回快照响应</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">snapshot_response</span><span class="token punctuation">(</span>sender<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> ack<span class="token punctuation">:</span> <span class="token class-name">Resp</span><span class="token punctuation">,</span> flag<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">&quot;snapshot_response ack: {:?}, flag: {}&quot;</span><span class="token punctuation">,</span> ack<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> resp <span class="token operator">=</span> <span class="token class-name">SnapshotResp</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resp<span class="token punctuation">.</span><span class="token function">set_resp</span><span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    resp<span class="token punctuation">.</span><span class="token function">set_flag</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> msg<span class="token punctuation">:</span> <span class="token class-name">Message</span> <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sender
        <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">(</span>
            <span class="token macro property">routing_key!</span><span class="token punctuation">(</span><span class="token class-name">Consensus</span> <span class="token operator">&gt;&gt;</span> <span class="token class-name">SnapshotResp</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">try_into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>SnapshotResp消息结构</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SnapshotResp</span> <span class="token punctuation">{</span>
    <span class="token comment">// message fields</span>
    <span class="token keyword">pub</span> resp<span class="token punctuation">:</span> <span class="token class-name">Resp</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> proof<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">SingularPtrField</span><span class="token operator">&lt;</span><span class="token keyword">super</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>blockchain<span class="token punctuation">::</span></span><span class="token class-name">Proof</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> height<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> flag<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    <span class="token comment">// special fields</span>
    unknown_fields<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">UnknownFields</span><span class="token punctuation">,</span>
    cached_size<span class="token punctuation">:</span> <span class="token punctuation">::</span><span class="token namespace">protobuf<span class="token punctuation">::</span></span><span class="token class-name">CachedSize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Resp</span> <span class="token punctuation">{</span>
    <span class="token class-name">BeginAck</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token class-name">ClearAck</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token class-name">SnapshotAck</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token class-name">RestoreAck</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token class-name">EndAck</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#bft模块订阅和发送的消息" title="Bft模块订阅和发送的消息">Bft模块订阅和发送的消息</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#共识的架构" title="共识的架构">共识的架构</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#基本约定" title="基本约定">基本约定</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#状态转换图" title="状态转换图">状态转换图</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#一、状态转换描述" title="一、状态转换描述">一、状态转换描述</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#二、subscribe-channel" title="二、Subscribe channel">二、Subscribe channel</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-1-compactsignedproposal" title="2.1 CompactSignedProposal">2.1 CompactSignedProposal</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-2-rawbytes" title="2.2 RawBytes">2.2 RawBytes</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-3-richstatus" title="2.3 RichStatus">2.3 RichStatus</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-4-blocktxs" title="2.4 BlockTxs">2.4 BlockTxs</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-5-verifyblockresp" title="2.5 VerifyBlockResp">2.5 VerifyBlockResp</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-6-snapshotreq" title="2.6 SnapshotReq">2.6 SnapshotReq</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#三、publish-channel" title="三、Publish channel">三、Publish channel</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-1-verifyblockreq" title="3.1 VerifyBlockReq">3.1 VerifyBlockReq</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-2-rawbytes" title="3.2 RawBytes">3.2 RawBytes</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-3-blockwithproof" title="3.3 BlockWithProof">3.3 BlockWithProof</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-4-compactsignedproposal" title="3.4 CompactSignedProposal">3.4 CompactSignedProposal</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-5-signedproposal" title="3.5 SignedProposal">3.5 SignedProposal</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-6-snapshotresp" title="3.6 SnapshotResp">3.6 SnapshotResp</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/zhendexuebuhui" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="mailto:xiongtianminn@163.com" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-3d9deeb8><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-3d9deeb8></path><polyline points="22,6 12,13 2,6" data-v-3d9deeb8></polyline></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="https://y.qq.com/n/ryqq/profile/like/playlist" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-music" data-v-3d9deeb8><path d="M9 18V5l12-2v13" data-v-3d9deeb8></path><circle cx="6" cy="18" r="3" data-v-3d9deeb8></circle><circle cx="18" cy="16" r="3" data-v-3d9deeb8></circle></svg>
          
        </a></li><li class="contact-item" data-v-3d9deeb8><a href="/blog/" class="nav-link" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-globe" data-v-3d9deeb8><circle cx="12" cy="12" r="10" data-v-3d9deeb8></circle><line x1="2" y1="12" x2="22" y2="12" data-v-3d9deeb8></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>Privacy Policy</a></li><li class="copyright-item" data-v-3d9deeb8>Copyright © 2023</li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.291cba69.js" defer></script><script src="/blog/assets/js/6.9e2f87d1.js" defer></script><script src="/blog/assets/js/3.ee97f597.js" defer></script><script src="/blog/assets/js/21.c8450320.js" defer></script>
  </body>
</html>
